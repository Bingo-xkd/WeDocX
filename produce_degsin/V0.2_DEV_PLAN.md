# WeDocX - v0.2 (产品化与体验优化) 开发计划

**版本目标**: 搭建稳定可靠的客户端/服务端架构，引入微信机器人作为用户入口，并建立后台管理界面，提升产品稳定性和可管理性。
**对应分支**: `feature/v0.2`

---

## 任务清单 (Task Checklist)

### 1. 【项目准备与架构设计】
- [OK] **前置任务**: 确认 v0.1 版本代码 (`feature/v0.1-mvp`) 已合并到 `main` 分支并创建 `v0.1` 标签。
- [OK] 基于 `main` 分支创建 v0.2 开发分支 `feature/v0.2`。
- [OK] **技术选型**: 调研并确定微信机器人框架 (备选: `wechaty`, `itchat`)，优先考虑稳定性和社区支持（**推荐：Wechaty**）。
- [OK] **技术选型**: 调研并确定后台管理界面框架 (备选: `FastAPI-Admin`, `SQLAdmin`)，优先考虑与FastAPI的集成度（**推荐：SQLAdmin**）。
- [OK] **架构设计**: 绘制 v0.2 系统架构图 [v0.2_architecture](../technical_select/v0.2_architecture.md)，明确新增的"微信机器人"和"后台管理"模块与现有服务的交互关系。
- [OK] **详细模块设计**: 拆解各主要模块的子功能点，输出详细设计文档。

### 2. 【服务端增强 - 健壮性】
- [ ] **环境配置**: 优化 `config.py`，支持通过 `.env` 文件和环境变量加载配置，实现开发与生产环境的隔离。
- [ ] **日志系统**: 引入 `loguru`，统一 FastAPI 和 Celery 的日志格式，将日志输出到文件并按日期切分。
- [ ] **异常处理**: 完善 FastAPI 的全局异常处理器，确保所有API错误都能返回统一格式的JSON响应。
- [ ] **API接口**: 设计/完善 `/api/v1/process-url`、`/api/v1/task-status`、`/api/v1/retry-task` 等接口，参数校验与统一响应。
- [ ] **业务逻辑**: 完善URL解析、任务创建、状态管理、文件生成等核心逻辑。
- [ ] **Celery集成**: 增强 Celery 任务的健壮性，为 `create_pdf_task` 和 `send_email_task` 添加自动重试机制，任务状态持久化。
- [ ] **单元测试**: 覆盖API、业务逻辑、异常处理、任务分发等关键流程。

### 3. 【客户端接入 - 微信机器人】
- [ ] **服务搭建**: 在项目下创建 `wechat_bot/` 目录，搭建基础的机器人服务。
- [ ] **消息监听**: 支持文本、图片、文件等多类型消息监听，区分群聊/私聊。
- [ ] **指令系统**: 实现 /help、/status <任务ID>、/start 等基础指令。
- [ ] **URL/任务ID解析**: 使用正则表达式解析URL、任务ID等关键信息。
- [ ] **API调用**: 调用 `/api/v1/process-url`、`/api/v1/task-status` 等接口，处理异常与重试。
- [ ] **用户反馈**: 主动推送任务状态、异常、结果等消息给用户。
- [ ] **日志与异常**: 记录消息、指令、API调用、异常等日志，支持日志分级。
- [ ] **单元测试**: 为消息解析、指令判断、API调用等关键逻辑编写单元测试。

### 4. 【后台管理界面】
- [ ] **数据建模**: 使用 `SQLAlchemy` 创建 `Task`、`User`、`Log` 等数据模型。
- [ ] **管理界面集成**: 集成 SQLAdmin 到 FastAPI 应用，配置路由、认证。
- [ ] **任务视图**: 创建任务列表、筛选、搜索、详情、重试、导出等页面。
- [ ] **权限与认证**: 实现基础认证体系，支持角色权限控制（可选）。
- [ ] **日志与用户管理**: 日志查询、用户管理、操作记录等。
- [ ] **单元测试**: 管理界面、模型、权限等测试。

### 5. 【存储与文件管理】
- [ ] **数据库设计**: 设计并迁移任务、用户、日志等表结构。
- [ ] **文件存储**: 设计PDF、导出文件等的存储、命名、清理策略。
- [ ] **数据备份**: 实现数据库/文件的备份与恢复（可选）。
- [ ] **单元测试**: 数据库操作、文件存储等测试。

### 6. 【集成与部署】
- [ ] **Docker容器化**: 编写 `docker-compose.yml`，容器化部署 FastAPI、Celery、Redis、Wechaty Bot、SQLAdmin。
- [ ] **集成测试**: 编写端到端流程测试，覆盖微信消息到任务完成全链路。
- [ ] **文档与运维**: 完善环境变量、启动方式、部署流程、常见问题文档。

### 选型结论
- 微信机器人框架：**推荐 Wechaty**（跨平台、社区活跃、适合生产环境）
- 后台管理界面框架：**推荐 SQLAdmin**（与FastAPI+SQLAlchemy深度集成，功能完善） 